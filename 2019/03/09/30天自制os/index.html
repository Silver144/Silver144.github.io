<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>30天自制os | Alice Blackbarn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="MathJax.Hub.Config({tex2jax: {inlineMath: [[&apos;$&apos;,&apos;$&apos;], [&apos;\\(&apos;,&apos;\\)&apos;]]}});   Day 0了解基本信息 1 . 此书所述的操作系统是用C语言和汇编写成的 2 . 此书的操作环境为Windows 3 . 步骤为，编写源代码-&amp;gt;编译成机器语言-&amp;gt;生成软盘镜像文件-&amp;gt;写入磁盘并作成启动盘 4 . 阶段性计划">
<meta property="og:type" content="article">
<meta property="og:title" content="30天自制os">
<meta property="og:url" content="http://yoursite.com/2019/03/09/30天自制os/index.html">
<meta property="og:site_name" content="Alice Blackbarn">
<meta property="og:description" content="MathJax.Hub.Config({tex2jax: {inlineMath: [[&apos;$&apos;,&apos;$&apos;], [&apos;\\(&apos;,&apos;\\)&apos;]]}});   Day 0了解基本信息 1 . 此书所述的操作系统是用C语言和汇编写成的 2 . 此书的操作环境为Windows 3 . 步骤为，编写源代码-&amp;gt;编译成机器语言-&amp;gt;生成软盘镜像文件-&amp;gt;写入磁盘并作成启动盘 4 . 阶段性计划">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-03-17T11:25:53.549Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="30天自制os">
<meta name="twitter:description" content="MathJax.Hub.Config({tex2jax: {inlineMath: [[&apos;$&apos;,&apos;$&apos;], [&apos;\\(&apos;,&apos;\\)&apos;]]}});   Day 0了解基本信息 1 . 此书所述的操作系统是用C语言和汇编写成的 2 . 此书的操作环境为Windows 3 . 步骤为，编写源代码-&amp;gt;编译成机器语言-&amp;gt;生成软盘镜像文件-&amp;gt;写入磁盘并作成启动盘 4 . 阶段性计划">
  
    <link rel="alternate" href="/atom.xml" title="Alice Blackbarn" type="application/atom+xml">
  
  
    <link rel="icon" href="https://www.zizi.world/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://www.zizi.world/favicon.ico">
    <h2 class="author"></h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>13</strong><br>文章</div></a>
      <a href="/categories"><div><strong>5</strong><br>分类</div></a>
      <a href="/tags"><div><strong>1</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-30天自制os" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/09/30天自制os/" class="article-date">
  <time class="post-time" datetime="2019-03-09T02:19:07.000Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">09</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      30天自制os
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/操作系统/">操作系统</a>
  </div>

          
              
  &nbsp; | &nbsp;
  <div class="view-box">
    <span id="/2019/03/09/30天自制os/" class="leancloud_visitors" data-flag-title="30天自制os">
      &nbsp;阅读次数<span class="leancloud-visitors-count"></span>
    </span>
  </div>


          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>

<h3 id="Day-0"><a href="#Day-0" class="headerlink" title="Day 0"></a><strong>Day 0</strong></h3><p>了解基本信息</p>
<p>1 . 此书所述的操作系统是用C语言和汇编写成的</p>
<p>2 . 此书的操作环境为Windows</p>
<p>3 . 步骤为，编写源代码-&gt;编译成机器语言-&gt;生成软盘镜像文件-&gt;写入磁盘并作成启动盘</p>
<p>4 . 阶段性计划，分四周进行总结</p>
<p>ps : 背后有什么奇妙深刻原因让老师选用这本书做实践工作，我暂且蒙在启动区的软盘里面</p>
<a id="more"></a>
<hr>
<h3 id="Day-1"><a href="#Day-1" class="headerlink" title="Day 1"></a><strong>Day 1</strong></h3><p>由于版本0的.img文件可以为版本1或版本2的.nas文件编译得到，故现将光盘里提供的版本2的汇编程序helloos.nas使用nask.exe编译成helloos.img，并重命名为fdimage0.bin并放入含qemu.exe的文件夹，并调用对应文件夹中的Makefile(启动qemu-win.bat)从而得到结果</p>
<p>需要注意的地方：</p>
<p>1 . $代表当前行被汇编后的地址，在部分参考书中还会有$$，这个符号代表当前节被汇编后的地址</p>
<p>2 . 0x55，0xAA为前512字节的最后两个字节，以0x55，0xAA结尾代表此扇区的开头为一个启动程序</p>
<hr>
<h3 id="Day-2"><a href="#Day-2" class="headerlink" title="Day 2"></a><strong>Day 2</strong></h3><p>与第一天一样，制作出来的东西作用完全相同，不同的是Day2用8086汇编指令制作启动区，剩下的工作交给磁盘映像管理工具，并在helloos5中将脚本整合成了Makefile文件</p>
<p>需要注意的地方：</p>
<p>1 . org 0x7c00. BIOS发现引导扇区后，会将这些内容装载到内存0x7c00处</p>
<p>2 . int 0x10 为调用中断服务程序，根据ah的不同会有不同的服务，在此程序中                    ah = 0x0e 为显示字符，al为字符的ascii码，bl为前景色</p>
<p>使用Makefile可以大大提高工作效率</p>
<hr>
<h3 id="Day-3"><a href="#Day-3" class="headerlink" title="Day 3"></a><strong>Day 3</strong></h3><p>1 . 开始版本(a~d)的作用是读取磁盘中的内容到内存特定位置，首先测试一下，如果屏幕上没出现错误信息那么就成功了，符合预期</p>
<p>(1) . 调用 int 0x13，ah = 0x02作用为读取磁盘内容，al为扇区数，ch为柱面号，cl为扇区号，dh为磁头号，dl为驱动器号，es:bx为缓冲区地址，实际地址为es <script type="math/tex">\times</script> 0x10 + bx</p>
<p>(2) . 考虑到从磁盘数据读取可能会出现问题，因此示例程序增加了retry部分，并设置retry次数上限</p>
<p>2 . 中间的版本(e~g)将引导区代码和操作系统代码分开，并用工具写入同一个磁盘，对g进行测试，qemu界面为全黑，符合预期</p>
<p>(1) . 在haribote.img中，操作系统文件名存储在0x2600处，主体部分存储在0x4200处，在(e)中，主体只有三个字节</p>
<p>(2) . 由于磁盘内容被转移至以0x8000为头的内存区域，故操作系统主体在内存中的位置为0xc200，在代码开头要加上org 0xc200，并在ipl.nas的next代码段最后加上jmp 0xc200</p>
<p>(3) . 为了能够有显示，需要调用int 0x10，令ah = 0x00即为设定显示模式，al为想要设定的模式，此处设定al = 0x13，因此，如果确实执行了我们的操作系统的代码，画面将会变为全黑</p>
<p>3 . 接下来的版本(h~j)进入32位模式并导入c语言</p>
<p>(1) . 记录BOOT_INFO，包括画面模式(示例代码为320x200x8bit)，VRAM地址等</p>
<p>(2) . 将haribote.nas改为asmhead.nas，加入新的代码来切换32位模式并调用c程序</p>
<p>(3) . 示例程序为bootpack.c，先编译成.gas文件，然后转化为.nas文件，再制作成.obj文件，生成.bim二进制映像文件，最后处理为.hrb二进制文件</p>
<p>(4) . 由Makefile可知，作者将asmhead.nas编译为asmhead.bin并与bootpack.hrb做成haribote.sys，导入ipl10.bin所在的.img文件中</p>
<p>(5) . 在(j)中为了实现HLT，使用naskfunc.nas汇编代码设置全局函数，并在.c文件中调用</p>
<p>测试，若黑屏则基本正确，结果符合预期</p>
<hr>
<h3 id="Day-4"><a href="#Day-4" class="headerlink" title="Day 4"></a><strong>Day 4</strong></h3><p>今天的内容是用c语言将数据写入显存区域(0xa0000~0xaffff)，从而在屏幕上显示图案</p>
<p>在harib01a中，函数由汇编编写，参数存放在栈中，让c程序进行调用，显示的效果为纯白屏</p>
<p>harib01b与harib01a差别不大，使用&amp;运算符将图案与地址产生关联从而让图案条形化</p>
<p>harib01c则不需要用汇编，直接使用指针将数据写入显存，d，e均为指针的应用</p>
<p>harib01f为颜色的设定</p>
<p>(1) . 作者使用字符数组，设置每三个相邻的字符为一个颜色的R，G，B，先使用io_out()将调色板号写入0x03c8，然后按R，G，B的顺序写入0x03c9，重复16次，调色板设置完毕</p>
<p>(2) . 进行端口写入时，要关闭中断，可由cli实现，结束后应使用sti恢复中断位，本书中因为中断位存储在EFLAGS寄存器中，可提前将EFLAGS使用pushfd入栈，操作完后使用popfd出栈</p>
<p>harib01g与harib01h是在harib01f的基础上的实践，使用调好的颜色绘制了矩形，我在这里稍微修改了一下代码，画了一个三角形</p>
<h3 id="Day-5"><a href="#Day-5" class="headerlink" title="Day 5"></a><strong>Day 5</strong></h3><p>为了使用方便与灵活，将画面信息使用指针存储到变量中，然后将相关信息组织成结构体，易于调用</p>
<p>a，b，c均是在介绍结构体，从d开始回到显示上去</p>
<p>d中显示字符使用8<script type="math/tex">\times</script>16的长方形像素点阵来表示一个字符，使用位运算的方法将字符写入显存</p>
<p>e中增加了字符，使用makefont.exe将字符文件编译成二进制文件，处理之后再链接，就可以通过hankaku + ch <script type="math/tex">\times</script> 16来索引相关的字符了，f则在e的基础上实现了显示字符串的功能，g则使用sprintf函数将变量的值化为字符串从而显示到屏幕上，h在内存中存储了一个大小为16<script type="math/tex">\times</script>16的鼠标指针(透明的地方填充背景色)</p>
<p>i中进行了GDT的初始化(其实在进入32位的时候就已经使用GDT了)</p>
<p>1 . GDT全称Global Descriptor Table，作用是存放段的描述符，其入口由LGDT指令加载到GDTR，LDT就是Local Descriptor Table</p>
<p>2 . 段描述符包括段长，段界限，段属性</p>
<p>首先初始了8192个段，程序中界定了两个段，第一个大小为0xffffffff，基地址为0x00000000，属性为0x4092，第二个大小为0x0007ffff，基地址为0x00280000，属性为0x409a，使用LGDT命令将GDT加载到0x00270000</p>
<p>IDT为中断描述符表，CPU在执行中断程序时，会在IDT中查找对应的中断服务程序，详细内容作者准备第二天再讲</p>
<h3 id="Day-6"><a href="#Day-6" class="headerlink" title="Day 6"></a><strong>Day 6</strong></h3><p>开始的工作是分割了源文件，组织头文件，以及整理了Makefile文件，使得结构更加清晰易懂，编译速度也更快，接下来对Day 5的GDT的知识做了相关补充</p>
<p>1 . GDTR为48位，高32位存放GDT基址，低16位存放GDT限长(为GDT字节数-1)，IDTR类似</p>
<p>2 . 在段描述符中，存在把段基址和段大小分成若干部分的现象，这是为了与之前的80286时代的程序兼容</p>
<p>3 . 实际上段界限最多只有20位，表面上有3个字节，实际上有4bit为段属性，这样的话，段的大小最大为1M，但是如果把单位解释称页，就可以达到4G</p>
<p>4 . 设置段属性的作用是防止非特权级程序访问系统专用段，从而危害操作系统</p>
<p>接下来是中断的一些重要知识</p>
<p>1 . PIC分为主从PCI，从PIC连接到主PIC的IRQ2上</p>
<p>2 . PIC内部有中断屏蔽寄存器，8位对应8路IRQ信号，用于忽视中断请求，还有初始化控制数据ICW，ICW1、ICW4用于设置电气参数，ICW3设置为00000100是因为IRQ2用于驱动从PIC，ICW2决定用哪一个管脚通知CPU</p>
<p>3 . int 0x00~0x1f不能用于IRQ，故用int 0x20~0x2f接收IRQ0~15，键盘是IRQ1，鼠标是IRQ12，而对于部分计算机PIC初始化时会产生IRQ7中断</p>
<p>4 . 在调用inthandler21时，需要保护现场(相关寄存器压栈)，执行完返回前要恢复现场(寄存器出栈)，然后执行IRETD</p>
<p>5 . 使用中断处理函数前，需要在IDT中进行注册，这样，CPU在发生中断时，就会自动调用相关处理函数，我在这里修改了一下函数，如果发生键盘中断，则显示keyboard interruption!</p>
<p>测试成功</p>
<h3 id="Day-7"><a href="#Day-7" class="headerlink" title="Day 7"></a><strong>Day 7</strong></h3><p>接着上一天的工作，在处理键盘中断的同时获得按键的编码，在此之前，在inthandler21函数中添加一句io_out8(PIC_OCW2, 0x61); 使得PIC能够继续监视IRQ1中断，读取0x60端口的数据，即为大小为8bit的按键编码</p>
<p>为了减少中断服务程序的大小，暂时设立了一个大小为1个字节的缓冲区，并修改HariMain函数使得产生键盘中断时能够CPU能够被唤醒并打印数据，平常情况则休眠，但是如果中断的频率过多则会遗漏，因此要制作FIFO缓冲区</p>
<p>1 . 根据先来先处理的原则，此缓冲区为FIFO缓冲区</p>
<p>2 . 缓冲区整合为结构体更加灵活，不仅可以任意取地址，而且可以设置标记来标注其状态</p>
<p>为了能够接收鼠标中断，要先令鼠标控制电路有效，再令鼠标有效，实际上如果键盘控制电路有效则鼠标电路就有效，然而键盘控制电路并没有CPU快，故许需要等到键盘控制电路可以处理信息时CPU再发送指令，设置为鼠标模式，然后激活鼠标，此时，鼠标会产生一个中断，此处修改了一下代码，若鼠标产生中断，则显示mouse interruption!</p>
<p>测试成功</p>
<p>接下来是获得从鼠标发送来鼠标的数据，根据代码可以看出，除了分别通知PIC1、PIC0，IRQ12、IRQ2的受理已经完成，其他的几乎一样，且读数据的端口也是0x60端口，有缓冲区的帮助，获得并使用鼠标数据的方法也简单了，但是我们使用鼠标是为了让它动起来，于是需要把数据进行适当的转换，这就是下一天的工作了</p>
<h3 id="Day-8"><a href="#Day-8" class="headerlink" title="Day 8"></a><strong>Day 8</strong></h3><p>这一天的首要工作是解读鼠标的信息，并让鼠标在屏幕上移动</p>
<p>1 . 鼠标发送3个字节的信息为1组，一开始的工作是将3个字节的信息分别放入一个特定的数组，完成后一起显示到屏幕上，其中关于鼠标数据的信息可以整合成结构体</p>
<p>2 . 在MOUSE_DEC结构体中，unsigned char buf[3]存储鼠标发送的3个字节，phase为其存到第n个字节的状态标识，x为buf[1]的内容，y为buf[2]的内容，根据测试，x、y的含义分别是一段时间内鼠标横纵坐标的<strong>相对变化量</strong>，鼠标的btn为buf[0]的第0~2位，<strong>0~2位为1分别代表操作了左键、右键、滚轮</strong>，根据buf[0]第4位、第5位的值分别对x、y做出修正(实则为将16位负数变为64位负数)，通过初始坐标我们就能计算鼠标的实时坐标</p>
<p>3 . 在绘制鼠标的时候，注意鼠标不能越界，同时，绘制新的鼠标和坐标前，要先将原来的数据和鼠标用背景色填充，这样，鼠标就可以绘制出来，而且其坐标也能一清二楚，不过需要注意其坐标原点位于左上顶点</p>
<p>接下来要讨论进入32位模式前的一些工作</p>
<p>在看的另一本参考书中，进入保护模式的主要步骤有以下几个</p>
<p>1 . 准备GDT</p>
<p>2 . 用LGDT加载GDTR</p>
<p>3 . 打开A20地址线</p>
<p>4 . 置cr0的PE位</p>
<p>5 . 跳转，进入保护模式</p>
<p>在这本书中，首先禁止了中断，防止干扰，然后打开了A20地址线，使CPU获得1M以上的寻址能力，接下来加载了临时的GDT，并设置cr0寄存器，设置PG位为0从而禁止分页，PE位为1从而切换到保护模式，然后将所有的段寄存器(除了CS)设置为0x08</p>
<p>接下来的代码将bootpack开始的地址开始的512KB的内容复制到0x280000的位置，将0x7c00处的启动扇区复制到0x100000的位置，将0x8200处的磁盘内容复制到0x100200处，这样做是作者设计了内存分布的情况，0x100000~0x267ffff用于保存软盘的内容</p>
<p>后面的代码就是先对bootpack.hrb中部分内容进行传送，等到没有要传送的数据的时候，从0x28001b执行bootpack.hrb</p>
<p>接下来的作用就是将0x60端口的冗余数据清理出来，紧接着是memcpy程序，单位为4字节，asmhead.nas的最后则是定义GDT0和GDTR0，并对齐至16字节，通过代码看出，GDT0规定的<strong>可读写段从0x00000000开始，界限为0xfffff，可执行段从0x00280000开始，界限为0x7ffff</strong></p>
<p>最后在HariMain()中创建GDT和IDT后，初始化PIC，打开中断并进行相关设备的初始化就可以处理中断了，至此，工作已经结束，其中部分问题会在以后解释</p>
<h3 id="Day-9"><a href="#Day-9" class="headerlink" title="Day 9"></a><strong>Day 9</strong></h3><p>今天的第一个任务是进行内存容量检查</p>
<p>1 . 测试cpu是否为486及以上，若是，则关闭高速缓存</p>
<p>2 . 开始测试内存，一开始向内存中写入一个值，然后反转，测试是否相等，若相等，则再次反转测试是否相等，若仍相等，则此内存有效</p>
<p>3 . 测试时注意编译器的优化问题导致程序失效</p>
<p>第二个任务是管理内存，以128M的内存为例</p>
<p>1 . 比较简单的方法是将128MB的内存划分为32768个4KB大小的区域，然后设置一个大小为32768的数组，来标记哪些块目前为可用。</p>
<p>2 . 也可以使用结构体列表的思路，将空闲地址基址与大小写入结构体数组，然后需要时数组轮询即可得到需要的资源，这样占用的内存也少</p>
<p>3 . 在使用结构体的策略时，可以将零散的小空闲内存合并为大的整块空闲内存，这样既节省空间，也减少程序轮询的次数</p>
<p>4 . 归还内存时首先测试是否能与前一块的内存区域合并成一块更大的空闲内存，若可以则合并，然后测试能否与后一块内存区域合并，若可以则合并，若均不可以，则加一块描述符用于描述新释放的内存</p>
<p>若只在HariMain()函数分配0x00001000~0x0009e000与0x00400000~0x00500000，则可用内存加起来仅有5752KB</p>
<h3 id="Day-10"><a href="#Day-10" class="headerlink" title="Day 10"></a><strong>Day 10</strong></h3><p>今天首先继续进行内存管理</p>
<p>1 . 把内存分配和释放的最小单位为4KB，这样有助于管理，而且不会产生大量的不连续的小内存段</p>
<p>2 . i = (i + 0xfff) \&amp; 0xffffff000 的意思与 x = ((x + 99) / 100) $\times$100的意思差不多，前者是为了将第四位向上取整，后者是百位向上取整</p>
<p>接下来是实现叠加窗口，这个需要不断地重新绘制才能达到目的</p>
<p>1 . 首先创建一个图层结构体，用于存储每一个图层的信息(坐标、大小、每一个像素的值、高度等，我理解的高度为图层的优先显示程度)</p>
<p>2 . 若要切换窗口，只需要修改某个图层的高度，然后调整其他图层的高度</p>
<p>3 . 在刷新函数中，使用的策略为从图层0到图层top，逐个在vram里面写入，达到覆盖的效果，但是由于写入的次数过多，故会产生卡顿</p>
<p>4 . 里面的背景色号为判断图层的这一处是否应该覆盖，若为背景色，则此处保留上一个图层的颜色，而颜色编号为0~15，故背景色设为99</p>
<p>5 . 每产生一次鼠标中断，屏幕会刷新一次，这样，鼠标就能运动起来</p>
<p>由于之前的函数写入次数过多，故接下来进行一些改进</p>
<p>1 . 仅仅设置移动区域进行重写，其他区域保持不动，这样工作量确实少了一些，但是并不明显</p>
<p>2 . 虽然其他区域保持不动，但是还是要进行大量的if判断，浪费了时间，因此，需要改动循环的范围，原来在其图层上每个点都遍历，现在仅在移动的区域进行遍历，减少了循环的次数，从而也大大降低了工作量，比之前的更加流畅</p>
<p>至此，图层覆盖的问题也能够解决了</p>
<h3 id="Day-11"><a href="#Day-11" class="headerlink" title="Day 11"></a><strong>Day 11</strong></h3><p>今天的首要事情是支持鼠标能够真正实现全屏幕覆盖，这个问题比较简单，进行如下修改:</p>
<p>a. 仅满足左上角的点可以位于频幕</p>
<p>b .仅仅刷新鼠标矩形与整个窗口重叠的地方</p>
<p>这样鼠标就可以实现全屏幕覆盖而且在窗口外可以隐藏一部分了</p>
<p>接下来就是做窗口了，大体思路是要先初始化一个图层，并绘制上相应的东西，做了如下操作：</p>
<p>1 . 绘制关闭按钮，与鼠标的绘制有相似之处</p>
<p>2 . 创建窗口图层并设置相应的缓冲区，申请内存</p>
<p>3 . 在窗口的缓冲区(buf_win)中写入字符</p>
<p>4 . 调整窗口出现的位置并设置优先级(鼠标最上，vram最下)，然后显示</p>
<p>成功显示</p>
<p>接下来是进行的一个小应用，令计数器无限计数并使用窗口显示，这个只需要修改循环中的代码就可以了，这里我将sprintf中的参数counter改为counter / 1000，可见的速率减慢为原来的1 / 1000</p>
<p>很明显这里有闪烁的迹象，原因是每次循环都是先刷新整个界面，然后是窗口，最后是鼠标，在刷新整个界面的时候就会看到相应的地方在闪烁(仅数字地方刷新是因为上一天的优化策略)，于是，将刷新函数修改为仅让想刷新的图层及以上刷新</p>
<p>闪烁现象消失了(截图看不出任何现象)</p>
<p>但是还是会有一个问题：鼠标的优先级比窗口要高，鼠标放在上面的时候依然会闪烁，于是，需要一种新的刷新方法，大体思路如下</p>
<p>1 . 创立buf_map，使得屏幕上每一个像素对应一个标记，这个标记与每一个图层是一一对应的</p>
<p>2 . 于是，从底层图层往高层图层刷新的时候，若某层某处在刷新区内，但是此处在map中的标记为更高级的图层，则并不会将颜色写入内存</p>
<p>这样的话，刷新时鼠标不会闪烁，性能的话，虽然每次刷新前需要刷新map可能会有额外的开销，但是当重叠区域过多时，写内存的开销会极大，此时刷新map可去除这些开销，综合下来性能有所提高</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/09/30天自制os/" data-id="cjtcu3qdu00020ovbx3yeocjk" class="article-share-link">分享</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/13/Partial-Differential-Equation/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Partial Differential Equation
        
      </div>
    </a>
  
  
    <a href="/2019/01/05/os异常记录/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">os异常记录</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Alice Blackbarn</h1>
    <h2 class="blog-subtitle"></h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://www.zizi.world/favicon.ico">
    <h2 class="author"></h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>13</strong><br>文章</div></a>
      <a href="/categories"><div><strong>5</strong><br>分类</div></a>
      <a href="/tags"><div><strong>1</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://score.royalflare.net" target="_blank" title="皇家烈焰">
          皇家烈焰
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://blog.csdn.net/xfgryujk" target="_blank" title="xfgryujk">
          xfgryujk
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <h1>revive</h1>
    </div>
    
  </div>
</footer>

    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("", "");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.article-title').length > 1) {
        showTime(Counter);
      }
    });
  </script>





  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>